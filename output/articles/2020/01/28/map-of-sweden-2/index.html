<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml">
<head>
    <title>Map of Sweden #2 - Wolfblog</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">




<style type="text/css">

/*some stuff for output/input prompts*/
div.cell{border:1px solid transparent;display:-webkit-box;-webkit-box-orient:vertical;-webkit-box-align:stretch;display:-moz-box;-moz-box-orient:vertical;-moz-box-align:stretch;display:box;box-orient:vertical;box-align:stretch;display:flex;flex-direction:column;align-items:stretch}div.cell.selected{border-radius:4px;border:thin #ababab solid}
div.cell.edit_mode{border-radius:4px;border:thin #008000 solid}
div.cell{width:100%;padding:5px 5px 5px 0;margin:0;outline:none}
div.prompt{min-width:11ex;padding:.4em;margin:0;font-family:monospace;text-align:right;line-height:1.21429em}
@media (max-width:480px){div.prompt{text-align:left}}div.inner_cell{display:-webkit-box;-webkit-box-orient:vertical;-webkit-box-align:stretch;display:-moz-box;-moz-box-orient:vertical;-moz-box-align:stretch;display:box;box-orient:vertical;box-align:stretch;display:flex;flex-direction:column;align-items:stretch;-webkit-box-flex:1;-moz-box-flex:1;box-flex:1;flex:1}
div.input_area{border:1px solid #cfcfcf;border-radius:4px;background:#f7f7f7;line-height:1.21429em}
div.prompt:empty{padding-top:0;padding-bottom:0}
div.input{page-break-inside:avoid;display:-webkit-box;-webkit-box-orient:horizontal;-webkit-box-align:stretch;display:-moz-box;-moz-box-orient:horizontal;-moz-box-align:stretch;display:box;box-orient:horizontal;box-align:stretch;}
div.inner_cell{width:90%;}
div.input_area{border:1px solid #cfcfcf;border-radius:4px;background:#f7f7f7;}
div.input_prompt{color:navy;border-top:1px solid transparent;}
div.output_wrapper{margin-top:5px;position:relative;display:-webkit-box;-webkit-box-orient:vertical;-webkit-box-align:stretch;display:-moz-box;-moz-box-orient:vertical;-moz-box-align:stretch;display:box;box-orient:vertical;box-align:stretch;width:100%;}
div.output_scroll{height:24em;width:100%;overflow:auto;border-radius:4px;-webkit-box-shadow:inset 0 2px 8px rgba(0, 0, 0, 0.8);-moz-box-shadow:inset 0 2px 8px rgba(0, 0, 0, 0.8);box-shadow:inset 0 2px 8px rgba(0, 0, 0, 0.8);}
div.output_collapsed{margin:0px;padding:0px;display:-webkit-box;-webkit-box-orient:vertical;-webkit-box-align:stretch;display:-moz-box;-moz-box-orient:vertical;-moz-box-align:stretch;display:box;box-orient:vertical;box-align:stretch;width:100%;}
div.out_prompt_overlay{height:100%;padding:0px 0.4em;position:absolute;border-radius:4px;}
div.out_prompt_overlay:hover{-webkit-box-shadow:inset 0 0 1px #000000;-moz-box-shadow:inset 0 0 1px #000000;box-shadow:inset 0 0 1px #000000;background:rgba(240, 240, 240, 0.5);}
div.output_prompt{color:darkred;}

a.anchor-link:link{text-decoration:none;padding:0px 20px;visibility:hidden;}
h1:hover .anchor-link,h2:hover .anchor-link,h3:hover .anchor-link,h4:hover .anchor-link,h5:hover .anchor-link,h6:hover .anchor-link{visibility:visible;}
/* end stuff for output/input prompts*/


.highlight-ipynb .hll { background-color: #ffffcc }
.highlight-ipynb  { background: #f8f8f8; }
.highlight-ipynb .c { color: #408080; font-style: italic } /* Comment */
.highlight-ipynb .err { border: 1px solid #FF0000 } /* Error */
.highlight-ipynb .k { color: #008000; font-weight: bold } /* Keyword */
.highlight-ipynb .o { color: #666666 } /* Operator */
.highlight-ipynb .cm { color: #408080; font-style: italic } /* Comment.Multiline */
.highlight-ipynb .cp { color: #BC7A00 } /* Comment.Preproc */
.highlight-ipynb .c1 { color: #408080; font-style: italic } /* Comment.Single */
.highlight-ipynb .cs { color: #408080; font-style: italic } /* Comment.Special */
.highlight-ipynb .gd { color: #A00000 } /* Generic.Deleted */
.highlight-ipynb .ge { font-style: italic } /* Generic.Emph */
.highlight-ipynb .gr { color: #FF0000 } /* Generic.Error */
.highlight-ipynb .gh { color: #000080; font-weight: bold } /* Generic.Heading */
.highlight-ipynb .gi { color: #00A000 } /* Generic.Inserted */
.highlight-ipynb .go { color: #888888 } /* Generic.Output */
.highlight-ipynb .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
.highlight-ipynb .gs { font-weight: bold } /* Generic.Strong */
.highlight-ipynb .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.highlight-ipynb .gt { color: #0044DD } /* Generic.Traceback */
.highlight-ipynb .kc { color: #008000; font-weight: bold } /* Keyword.Constant */
.highlight-ipynb .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
.highlight-ipynb .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
.highlight-ipynb .kp { color: #008000 } /* Keyword.Pseudo */
.highlight-ipynb .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
.highlight-ipynb .kt { color: #B00040 } /* Keyword.Type */
.highlight-ipynb .m { color: #666666 } /* Literal.Number */
.highlight-ipynb .s { color: #BA2121 } /* Literal.String */
.highlight-ipynb .na { color: #7D9029 } /* Name.Attribute */
.highlight-ipynb .nb { color: #008000 } /* Name.Builtin */
.highlight-ipynb .nc { color: #0000FF; font-weight: bold } /* Name.Class */
.highlight-ipynb .no { color: #880000 } /* Name.Constant */
.highlight-ipynb .nd { color: #AA22FF } /* Name.Decorator */
.highlight-ipynb .ni { color: #999999; font-weight: bold } /* Name.Entity */
.highlight-ipynb .ne { color: #D2413A; font-weight: bold } /* Name.Exception */
.highlight-ipynb .nf { color: #0000FF } /* Name.Function */
.highlight-ipynb .nl { color: #A0A000 } /* Name.Label */
.highlight-ipynb .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
.highlight-ipynb .nt { color: #008000; font-weight: bold } /* Name.Tag */
.highlight-ipynb .nv { color: #19177C } /* Name.Variable */
.highlight-ipynb .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
.highlight-ipynb .w { color: #bbbbbb } /* Text.Whitespace */
.highlight-ipynb .mf { color: #666666 } /* Literal.Number.Float */
.highlight-ipynb .mh { color: #666666 } /* Literal.Number.Hex */
.highlight-ipynb .mi { color: #666666 } /* Literal.Number.Integer */
.highlight-ipynb .mo { color: #666666 } /* Literal.Number.Oct */
.highlight-ipynb .sb { color: #BA2121 } /* Literal.String.Backtick */
.highlight-ipynb .sc { color: #BA2121 } /* Literal.String.Char */
.highlight-ipynb .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
.highlight-ipynb .s2 { color: #BA2121 } /* Literal.String.Double */
.highlight-ipynb .se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
.highlight-ipynb .sh { color: #BA2121 } /* Literal.String.Heredoc */
.highlight-ipynb .si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
.highlight-ipynb .sx { color: #008000 } /* Literal.String.Other */
.highlight-ipynb .sr { color: #BB6688 } /* Literal.String.Regex */
.highlight-ipynb .s1 { color: #BA2121 } /* Literal.String.Single */
.highlight-ipynb .ss { color: #19177C } /* Literal.String.Symbol */
.highlight-ipynb .bp { color: #008000 } /* Name.Builtin.Pseudo */
.highlight-ipynb .vc { color: #19177C } /* Name.Variable.Class */
.highlight-ipynb .vg { color: #19177C } /* Name.Variable.Global */
.highlight-ipynb .vi { color: #19177C } /* Name.Variable.Instance */
.highlight-ipynb .il { color: #666666 } /* Literal.Number.Integer.Long */
</style>

<style type="text/css">
/* Overrides of notebook CSS for static HTML export */
div.entry-content {
  overflow: visible;
  padding: 8px;
}
.input_area {
  padding: 0.2em;
}

a.heading-anchor {
 white-space: normal;
}

.rendered_html
code {
 font-size: .8em;
}

pre.ipynb {
  color: black;
  background: #f7f7f7;
  border: none;
  box-shadow: none;
  margin-bottom: 0;
  padding: 0;
  margin: 0px;
  font-size: 13px;
}

/* remove the prompt div from text cells */
div.text_cell .prompt {
    display: none;
}

/* remove horizontal padding from text cells, */
/* so it aligns with outer body text */
div.text_cell_render {
    padding: 0.5em 0em;
}

img.anim_icon{padding:0; border:0; vertical-align:middle; -webkit-box-shadow:none; -box-shadow:none}

div.collapseheader {
    width=100%;
    padding: 2px;
    cursor: pointer;
    font-family:"Helvetica Neue",Helvetica,Arial,sans-serif;
}

</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML" type="text/javascript"></script>
<script type="text/javascript">
init_mathjax = function() {
    if (window.MathJax) {
        // MathJax loaded
        MathJax.Hub.Config({
            tex2jax: {
                inlineMath: [ ['$','$'], ["\\(","\\)"] ],
                displayMath: [ ['$$','$$'], ["\\[","\\]"] ]
            },
            displayAlign: 'left', // Change this to 'center' to center equations.
            "HTML-CSS": {
                styles: {'.MathJax_Display': {"margin": 0}}
            }
        });
        MathJax.Hub.Queue(["Typeset",MathJax.Hub]);
    }
}
init_mathjax();
</script>

<link rel="canonical" href="/articles/2020/01/28/map-of-sweden-2/">

        <meta name="author" content="Mats Melander" />
        <meta name="keywords" content="D3,Maps" />
        <meta name="description" content="A note on making maps #2" />

        <meta property="og:site_name" content="Wolfblog" />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="Map of Sweden #2"/>
        <meta property="og:url" content="/articles/2020/01/28/map-of-sweden-2/"/>
        <meta property="og:description" content="A note on making maps #2"/>
        <meta property="article:published_time" content="2020-01-28" />
            <meta property="article:section" content="Technologies" />
            <meta property="article:tag" content="D3" />
            <meta property="article:tag" content="Maps" />
            <meta property="article:author" content="Mats Melander" />



    <!-- Bootstrap -->
        <link rel="stylesheet" href="/theme/css/bootstrap.min.css" type="text/css"/>
    <link href="/components/font-awesome/css/font-awesome.min.css" rel="stylesheet">

<!--    <link href="/theme/css/font-awesome.min.css" rel="stylesheet"> -->

    <link href="/theme/css/pygments/default.css" rel="stylesheet">
    <link rel="stylesheet" href="/theme/css/style.css" type="text/css"/>




</head>
<body>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="/" class="navbar-brand">
<img class="img-responsive pull-left gap-right" src="/img/Wolf_logo.png" width="30"/> Wolfblog            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                    <li><a href="/archives.html">Archive</a></li>
                         <li><a href="/pages/about/">
                             About
                          </a></li>
                        <li class="active">
                            <a href="/category/technologies">Technologies</a>
                        </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->

<!-- Banner -->
<!-- End Banner -->

<!-- Content Container -->
<div class="container">
    <div class="row">
        <div class="col-sm-9">
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="/articles/2020/01/28/map-of-sweden-2/"
                       rel="bookmark"
                       title="Permalink to Map of Sweden #2">
                        Map of Sweden #2
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2020-01-28T00:00:00+01:00"> Tue 28 January 2020</time>
    </span>





<span class="label label-default">Tags</span>
	<a href="/tag/d3">D3</a>
        /
	<a href="/tag/maps">Maps</a>
    
</footer><!-- /.post-info -->                    </div>
                </div>
                <p>In a previous post, I showed how to make a map of Sweden as a SVG object, derived from geometrical information,
using D3. Here, I will focus of collecting meteorological observations from <a class="reference external" href="https://opendata.smhi.se/apidocs/metobs/index.html">SMHI</a>
and create a simple HTTP-server that will respond with the data when requested. This will be made through 2 simple
python scripts.</p>
<div class="section" id="the-scripts">
<h2>The scripts</h2>
<p>There are two python 3.x scripts doing the work</p>
<ul class="simple">
<li><strong>collector.py:</strong> This script will traverse the SMHI REST API and store the data in JSON format in a file.
I have automated this script running once per day through crontab.</li>
<li><strong>emitter.py:</strong> This script is implemented as a HTTP-server, running as a background daemon. When it receives a
GET-request, it will read the JSON file, created by collector.py and respond to the client.</li>
</ul>
<p>I am using tools to have the workings of <strong>emitter.py</strong>; <a class="reference external" href="http://flask.pocoo.org/">Flask</a>,
<a class="reference external" href="https://gunicorn.org/">Gunicorn</a> and <a class="reference external" href="http://supervisord.org/introduction.html">Supervisor</a>.
They will be described below, but first I will start with installing them into a Python virtual environment.
In <strong>collector.py</strong> I will use requests library to access the SMHI observations, this library needs to be installed as well.</p>
<div class="section" id="installation">
<h3>Installation</h3>
<p>Assuming a &quot;clean&quot; raspberry pi in target (in my case named <strong>rpi2</strong>) do as below.
This will install <strong>pip</strong>, <strong>virtualenv</strong>, <strong>virtualenwrapper</strong>, <strong>autoenv</strong> and <strong>supervisor</strong> systemwide.
Following that I create the virtual environment clover using python3. <strong>requests</strong>, <strong>flask</strong> and <strong>gunicorn</strong> are
installed into the virtual environment, thus not system wide.</p>
<div class="highlight"><pre><span></span>$ sudo apt-get update
$ sudo apt-get install python-setuptools
$ sudo easy_install pip
$ sudo pip install virtualenv
$ sudo pip install virtualenvwrapper
$ sudo pip install autoenv
$ sudo apt-get install supervisor
$ mkvirtualenv --python<span class="o">=</span>/usr/bin/python3 clover
$ workon clover
<span class="o">(</span>clover<span class="o">)</span> $ pip3 install requests
<span class="o">(</span>clover<span class="o">)</span> $ pip3 install flask
<span class="o">(</span>clover<span class="o">)</span> $ pip3 install gunicorn
</pre></div>
<p>Now everything should be installed.</p>
</div>
</div>
<div class="section" id="smhi-meteorological-observations">
<h2>SMHI meteorological observations</h2>
<p>Time to find out how we access the meteorological observations.
This is how it is described by SMHI</p>
<blockquote>
The service is constructed as a REST API for easy access. The Entry point is located at
<a class="reference external" href="https://opendata-download-metobs.smhi.se/api">https://opendata-download-metobs.smhi.se/api</a>. From here a client can traverse down by following links through
the levels until a specific data resource is available.</blockquote>
<p>The <strong>collector.py</strong> script use <a class="reference external" href="http://opendata-download-metobs.smhi.se/api.json">http://opendata-download-metobs.smhi.se/api.json</a> as the starting point to access
observations. SMHI expose data in 3 different formats: 1) JSON 2) XML 3) CSV, I will only care about JSON.</p>
<p>There is a multitude of observations that can be accessed, for my purpose a subset of these will do:</p>
<ul class="simple">
<li><strong>Temp:</strong> Momentary value of air temperature, updated once per hour</li>
<li><strong>Average temp:</strong> Average air temperature for 1 day (24 h), at 00:00</li>
<li><strong>Rain:</strong> Sum once per day, at 06:00</li>
<li><strong>Relative humidity:</strong> Momentary value, once per hour</li>
<li><strong>Snow depth:</strong> Momentary value, once per hour</li>
<li><strong>Air pressure:</strong> At sea level, momentary value, once per hour</li>
<li><strong>Lowest cloud layer:</strong> Momentary value, once per hour</li>
</ul>
<p>I also collect <strong>Wind Direction</strong> and <strong>Wind Speed</strong> (average values over 10 min, once per hour) but these values are not used.</p>
<p>A Jupyter notebook is available <a class="reference external" href="https://github.com/Wolfrax/clover/tree/master/blog/Part%202">here</a> to show a
simple interaction.</p>
<p>For each data set, there are some meta-data available, such as:</p>
<ul class="simple">
<li><strong>Latitude and Longitude</strong> for each station</li>
<li><strong>Name</strong> of station</li>
<li><strong>Active</strong>, some stations might be inactive</li>
<li><strong>Update</strong>, when the data was updated</li>
</ul>
<p>All of above is collected together with the value of the observation into a structure by the collector script.</p>
<p><strong>Note this</strong> The stations will be different for each observation, e.g. the number of stations where rain observations
are available is larger than the number of stations for the air pressure observations. Therefore, we need to traverse
the API once per requested observation. To make the collector script somewhat more efficient it creates thread for
each observation so that the procedure is parallelized.</p>
<p>The final result is stored in the file <strong>weather.js</strong>.</p>
<p>The <strong>collector.py</strong> script is executed once per day using crontab. The entry in crontab is</p>
<div class="highlight"><pre><span></span><span class="m">00</span> <span class="m">1</span>    * * *   pi      /usr/bin/python3 /home/pi/app/clover/py/collector.py &gt;&gt; /var/log/clover.log <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span>
</pre></div>
<p>Note that the script is executed as user &quot;pi&quot; and that any printout from the script is collected into
<tt class="docutils literal">/var/log/clover.log</tt>. Ensure that the <strong>collector.py</strong> script have execution attribute set, that the
<strong>clover.log</strong> file exist in <strong>/var/log</strong> and is possible to write into. Use <strong>chmod</strong> and <strong>chown</strong> commands to do this.</p>
<p>The collector.py is short, not very complicated and available <a class="reference external" href="https://github.com/Wolfrax/clover/blob/master/py/collector.py">here</a> on GitHub.
The net result is a file, <strong>weather.js</strong>, in JSON format. The file name is hardcoded in the script as
<strong>../data/weather.js</strong>.</p>
<p>The beginning of the file looks like this</p>
<div class="highlight"><pre><span></span><span class="o">{</span>
    <span class="s2">&quot;date&quot;</span>: <span class="s2">&quot;2019-03-07&quot;</span>,
    <span class="s2">&quot;temp&quot;</span>: <span class="o">[{</span>
        <span class="s2">&quot;station&quot;</span>: <span class="s2">&quot;Abisko&quot;</span>,
        <span class="s2">&quot;updated&quot;</span>: <span class="m">1551985200000</span>,
        <span class="s2">&quot;lon&quot;</span>: <span class="m">18</span>.816546,
        <span class="s2">&quot;lat&quot;</span>: <span class="m">68</span>.354122,
        <span class="s2">&quot;active&quot;</span>: true,
        <span class="s2">&quot;val&quot;</span>: -15.5
    <span class="o">}</span>, <span class="o">{</span>
...
<span class="o">}</span>
</pre></div>
<p>The full file includes all stations for key temp. Other keys in the file are</p>
<ul class="simple">
<li><strong>avg_temp</strong></li>
<li><strong>wind_dir</strong> (not used)</li>
<li><strong>wind_speed</strong> (not used)</li>
<li><strong>rain</strong></li>
<li><strong>rel_moisture</strong> (humidity)</li>
<li><strong>snow_depth</strong></li>
<li><strong>pressure</strong></li>
<li><strong>lowest_cloud</strong></li>
</ul>
<p>The javascript that is accessing the data must use the exact key names shown above.</p>
</div>
<div class="section" id="emitter">
<h2>Emitter</h2>
<p>The last script to explain is <strong>emitter.py</strong>. This script is really short, the purpose of the script is to listen on
for HTTP GET-requests on the URI <strong>/clover_data</strong>, read the <strong>weather.js</strong> file and return the content to the HTTP client.
It is doing this through <strong>Gunicorn</strong> and <strong>Flask</strong>. The rationale for doing it this way is my local infrastructure
of raspberries.</p>
<p>My domain is <a class="reference external" href="https://www.viltstigen.se">https://www.viltstigen.se</a>, and I have one raspberry (<strong>rpi1</strong>) as HTTP server listening on port 80 and 443.
The collector script is executing on another raspberry (<strong>rpi2</strong>) upstream of <strong>rpi1</strong>.
The way to implement this is to use <a class="reference external" href="https://nginx.org/en/">nginx</a> as HTTP and proxy server on both <strong>rpi1</strong> and <strong>rpi2</strong>.</p>
<p>I need to configure nginx on <strong>rpi1</strong> to distribute requests to clover to <strong>rpi2</strong>.</p>
<div class="highlight"><pre><span></span><span class="k">location</span><span class="w"> </span><span class="s">/clover</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kn">try_files</span><span class="w"> </span><span class="nv">$uri</span><span class="w"> </span><span class="nv">$uri/</span><span class="w"> </span><span class="nv">$uri/index.html</span><span class="w"> </span><span class="nv">$uri.html</span><span class="w"> </span><span class="s">@clover</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">location</span><span class="w"> </span><span class="s">@clover</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1"># proxy_pass http://rpi2.local; Note, a static IP address makes nginx more robust in case rpi1 is not running</span>
<span class="w">    </span><span class="kn">proxy_pass</span><span class="w"> </span><span class="s">http://192.168.1.51</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kn">proxy_redirect</span><span class="w">     </span><span class="no">off</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kn">proxy_set_header</span><span class="w">   </span><span class="s">Host</span><span class="w"> </span><span class="nv">$host</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kn">proxy_set_header</span><span class="w">   </span><span class="s">X-Real-IP</span><span class="w"> </span><span class="nv">$remote_addr</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kn">proxy_set_header</span><span class="w">   </span><span class="s">X-Forwarded-For</span><span class="w"> </span><span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kn">proxy_set_header</span><span class="w">   </span><span class="s">X-Forwarded-Host</span><span class="w"> </span><span class="nv">$server_name</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kn">proxy_read_timeout</span><span class="w"> </span><span class="mi">300</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">location</span><span class="w"> </span><span class="s">/clover_data</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kn">try_files</span><span class="w"> </span><span class="nv">$uri</span><span class="w"> </span><span class="nv">$uri/</span><span class="w"> </span><span class="nv">$uri/index.html</span><span class="w"> </span><span class="nv">$uri.html</span><span class="w"> </span><span class="s">@clover_data</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">location</span><span class="w"> </span><span class="s">@clover_data</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1"># proxy_pass http://rpi2.local; Note, a static IP address makes nginx more robust in case rpi1 is not running</span>
<span class="w">    </span><span class="kn">proxy_pass</span><span class="w"> </span><span class="s">http://192.168.1.51:8096</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kn">proxy_redirect</span><span class="w">     </span><span class="no">off</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kn">proxy_set_header</span><span class="w">   </span><span class="s">Host</span><span class="w"> </span><span class="nv">$host</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kn">proxy_set_header</span><span class="w">   </span><span class="s">X-Real-IP</span><span class="w"> </span><span class="nv">$remote_addr</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kn">proxy_set_header</span><span class="w">   </span><span class="s">X-Forwarded-For</span><span class="w"> </span><span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kn">proxy_set_header</span><span class="w">   </span><span class="s">X-Forwarded-Host</span><span class="w"> </span><span class="nv">$server_name</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kn">proxy_read_timeout</span><span class="w"> </span><span class="mi">300</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
<p>When a HTTP client access the URI <a class="reference external" href="https://www.viltstigen.se/clover">https://www.viltstigen.se/clover</a>, <strong>rpi1</strong> will pass this to <strong>rpi2</strong>.
Similar, if a client access <a class="reference external" href="https://www.viltstigen.se/clover_data">https://www.viltstigen.se/clover_data</a>, <strong>rpi1</strong> will pass the request upstream to <strong>rpi2</strong> on
port 8096. As my raspberries is protected by the uncomplicated firewall (ufw), the ports on <strong>rpi2</strong> needs to be configured
to allow the traffic through these commands</p>
<div class="highlight"><pre><span></span>$ sudo ufw allow from <span class="m">192</span>.168.1.0/24 to any port <span class="m">8096</span>
$ sudo ufw allow from <span class="m">192</span>.168.1.0/24 to any port <span class="m">80</span>
</pre></div>
<p>Now an external HTTP-client can access <strong>rpi2</strong> through <strong>rpi1</strong>.</p>
<p>On <strong>rpi2</strong> a WSGI server is listening on port 8096 and executing a Flask application in the emitter script.
As the WSGI server is running as a daemon I use supervisor to control this. Supervisor is configured in the file
<strong>clover_gunicorn.conf</strong> (softlinked from <strong>/etc/supervisor/conf.d</strong> directory), the content looks like this</p>
<div class="highlight"><pre><span></span><span class="o">[</span>program:clover_gunicorn<span class="o">]</span>
<span class="nb">command</span> <span class="o">=</span> /home/pi/.virtualenvs/clover/bin/gunicorn -b :8096 --reload emitter:app
<span class="nv">directory</span> <span class="o">=</span> /home/pi/app/clover/py
<span class="nv">user</span> <span class="o">=</span> root
<span class="nv">autostart</span> <span class="o">=</span> <span class="nb">true</span>
<span class="nv">autorestart</span> <span class="o">=</span> <span class="nb">true</span>
<span class="nv">startretries</span><span class="o">=</span><span class="m">3</span>
<span class="nv">stdout_logfile</span> <span class="o">=</span> /var/log/supervisor/clover_gunicorn.log
<span class="nv">stderr_logfile</span> <span class="o">=</span> /var/log/supervisor/clover_gunicorn.err
</pre></div>
<p>This tells supervisor to execute gunicorn, bind it to port 8096 executing the Flask application &quot;app&quot; in module
&quot;emitter&quot;. It will automatically reload the Flask application if any changes are made.</p>
<p>Finally, the core of the Flask application is (the actual script includes more error handling than shown below)</p>
<div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>

<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">jsonify</span>
<span class="kn">import</span> <span class="nn">json</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/clover_data&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_data</span><span class="p">():</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;/var/local/clover_weather.js&quot;</span>  <span class="c1"># Hardcoded filename</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">json_file</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">json_file</span><span class="p">))</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s1">&#39;0.0.0.0&#39;</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
<p>Above tells us that the Flask application will respond to the URI <strong>/clover_data</strong> by reading the file
<strong>/var/local/clover_weather.js</strong> (which I have symlinked to the actual file weather.js) and returning the content as a
JSON formatted string. Flask is running in debug mode, in case I would like to use this debug mode,
I issue these commands:</p>
<div class="highlight"><pre><span></span>$ <span class="nb">export</span> <span class="nv">FLASK_APP</span><span class="o">=</span>emitter.py
$ <span class="nb">export</span> <span class="nv">FLASK_DEBUG</span><span class="o">=</span><span class="m">1</span>
$ flask run --host<span class="o">=</span><span class="m">0</span>.0.0.0 --port<span class="o">=</span><span class="m">8096</span>
</pre></div>
<p>and access the URI <a class="reference external" href="https://rpi2.local:8096/clover_data">https://rpi2.local:8096/clover_data</a> from a web browser.</p>
</div>

            </div>
            <!-- /.entry-content -->
        </article>
    </section>

        </div>
        <div class="col-sm-3" id="sidebar">
            <aside>
<!-- Sidebar -->
<section class="well well-sm">
  <ul class="list-group list-group-flush">

<!-- Sidebar/Recent Posts -->
<li class="list-group-item">
  <h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Recent Posts</span></h4>
  <ul class="list-group" id="recentposts">
    <li class="list-group-item"><a href="/articles/2021/11/08/visualizing-wind-using-leaflet/">Visualizing wind using Leaflet</a></li>
    <li class="list-group-item"><a href="/articles/2021/09/13/flask-application-behind-a-reverse-proxy/">Flask application behind a reverse proxy</a></li>
    <li class="list-group-item"><a href="/articles/2021/07/14/setting-referer-policy-when-using-applause-button/">Setting referer policy when using applause button</a></li>
    <li class="list-group-item"><a href="/articles/2021/05/02/mdns-for-linux/">mDNS for Linux</a></li>
    <li class="list-group-item"><a href="/articles/2020/10/07/rsyslog-daemon-filling-syslog/">rsyslog daemon filling syslog</a></li>
  </ul>
</li>
<!-- End Sidebar/Recent Posts -->

<!-- Sidebar/Github -->
<li class="list-group-item">
  <h4><i class="fa fa-github fa-lg"></i><span class="icon-label">GitHub Repos</span></h4>
  <div id="gh_repos">
    <p class="list-group-item">Status updating...</p>
  </div>
</li>
<!-- End Sidebar/Github -->

<!-- Sidebar/Links -->
<li class="list-group-item">
  <h4><i class="fa fa-external-link-square fa-lg"></i><span class="icon-label">Links</span></h4>
  <ul class="list-group" id="links">
    <li class="list-group-item">
      <a href="https://www.viltstigen.se/" target="_blank">Viltstigen</a>
    </li>
    <li class="list-group-item">
      <a href="http://wlog.viltstigen.se/" target="_blank">Wolfblog</a>
    </li>
    <li class="list-group-item">
      <a href="https://github.com/wolfrax" target="_blank">Github</a>
    </li>
  </ul>
</li>
<!-- End Sidebar/Links -->

<!-- Sidebar/Archive -->
<li class="list-group-item">
  <h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Archive</span></h4>
  <ul class="list-group" id="archive">
        <li class="list-group-item">
          <a href="/archive/2021/Nov/index.html"><i class="fa fa-calendar fa-lg"></i>November 2021 (1)
          </a>
        </li>
        <li class="list-group-item">
          <a href="/archive/2021/Sep/index.html"><i class="fa fa-calendar fa-lg"></i>September 2021 (1)
          </a>
        </li>
        <li class="list-group-item">
          <a href="/archive/2021/Jul/index.html"><i class="fa fa-calendar fa-lg"></i>July 2021 (1)
          </a>
        </li>
        <li class="list-group-item">
          <a href="/archive/2021/May/index.html"><i class="fa fa-calendar fa-lg"></i>May 2021 (1)
          </a>
        </li>
        <li class="list-group-item">
          <a href="/archive/2020/Oct/index.html"><i class="fa fa-calendar fa-lg"></i>October 2020 (2)
          </a>
        </li>
        <li class="list-group-item">
          <a href="/archive/2020/Jul/index.html"><i class="fa fa-calendar fa-lg"></i>July 2020 (2)
          </a>
        </li>
        <li class="list-group-item">
          <a href="/archive/2020/Jun/index.html"><i class="fa fa-calendar fa-lg"></i>June 2020 (1)
          </a>
        </li>
        <li class="list-group-item">
          <a href="/archive/2020/Feb/index.html"><i class="fa fa-calendar fa-lg"></i>February 2020 (6)
          </a>
        </li>
        <li class="list-group-item">
          <a href="/archive/2020/Jan/index.html"><i class="fa fa-calendar fa-lg"></i>January 2020 (11)
          </a>
        </li>
  </ul>
</li>
<!-- End Sidebar/Archive -->
  </ul>
</section>
<!-- End Sidebar -->            </aside>
        </div>
    </div>
</div>
<!-- End Content Container -->

<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2021 Mats Melander
            &middot; Powered by <a href="https://github.com/getpelican/pelican-themes/tree/master/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="/theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="/theme/js/respond.min.js"></script>



<!-- GitHub JS Code -->
<script type="text/javascript">
$(document).ready(function () {
  if (!window.jXHR) {
    var jxhr = document.createElement('script');
    jxhr.type = 'text/javascript';
    jxhr.src = '/theme/js/jXHR.js';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(jxhr, s);
  }

  github.showRepos({
    user: 'wolfrax',
    count: 5,
    skip_forks: false,
    target: '#gh_repos'
  });
});
</script>
<script src="/theme/js/github.js" type="text/javascript"></script>
<!-- End GitHub JS Code -->

<script type="text/javascript">
jQuery(document).ready(function($) {
    $("div.collapseheader").click(function () {
    $header = $(this).children("span").first();
    $codearea = $(this).children(".input_area");
    console.log($(this).children());
    $codearea.slideToggle(500, function () {
        $header.text(function () {
            return $codearea.is(":visible") ? "Collapse Code" : "Expand Code";
        });
    });
});
});
</script>
</body>
</html>